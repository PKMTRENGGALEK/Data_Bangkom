<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Detail Sertifikat Pegawai</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
      body {
        background: linear-gradient(135deg, #f8f9fa, #e3f2fd);
        font-size: 0.9rem;
        min-height: 100vh;
      }
      h3 {
        color: #be408a;
        font-weight: 600;
      }
      table.dataTable thead th {
        background-color: #be408a !important;
        color: #fff;
        text-align: center;
      }
      td {
        text-align: center;
        vertical-align: middle;
      }
      a.back-link {
        text-decoration: none;
        color: #be408a;
        font-weight: 600;
      }
      a.back-link:hover {
        color: #a52e74;
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <div class="mb-4 text-center">
        <h3 id="judul">Detail Sertifikat</h3>
        <p>
          <a href="index.html" class="back-link">&larr; Kembali ke daftar</a>
        </p>
      </div>

      <div class="card shadow-sm border-0 rounded-4">
        <div class="card-body">
          <div class="table-responsive">
            <table
              id="tabel-detail"
              class="table table-striped table-hover table-bordered align-middle"
            >
              <thead>
                <tr>
                  <th>No</th>
                  <th>Nama Pelatihan</th>
                  <th>No Sertifikat</th>
                  <th>Tanggal Sertifikat</th>
                  <th>Yang Mengeluarkan</th>
                  <th>Jumlah JP</th>
                  <th>Jumlah SKP</th>
                  <th>File</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
      const SHEET_ID = "118Ru4SfqkcHSb1hucQI11vYxA5jjT9TkmyCu5pDdISc";
      const SHEET_NAME = "Sheet1";
      const API_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`;

      async function fetchData() {
        const res = await fetch(API_URL + "&_=" + Date.now());
        const text = await res.text();
        const json = JSON.parse(
          text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1)
        );
        return json.table.rows;
      }

      async function renderDetail() {
        const params = new URLSearchParams(window.location.search);
        const nama = params.get("nama");
        if (!nama) {
          Swal.fire("Error", "Nama tidak ditemukan di URL.", "error");
          return;
        }

        document.getElementById("judul").textContent = `Data Bangkom: ${nama}`;

        const tbody = document.querySelector("#tabel-detail tbody");
        tbody.innerHTML =
          "<tr><td colspan='8' class='text-center text-muted'>⏳ Memuat data...</td></tr>";

        try {
          const rows = await fetchData();
          const data = rows
            .map((r) => r.c.map((c) => c?.v || ""))
            .filter((row) => row[1] === nama); // kolom ke-1 = Nama

          if (!data.length) {
            tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">Tidak ada sertifikat untuk ${nama}</td></tr>`;
            return;
          }

          let html = "";
          data.forEach((r, i) => {
            const fileLink = r[8]
              ? `<a href="${r[8]}" target="_blank" class="text-decoration-none text-primary">Lihat</a>`
              : "-";
            html += `
            <tr>
              <td>${i + 1}</td>
              <td>${r[2]}</td>
              <td>${r[3]}</td>
              <td>${r[4]}</td>
              <td>${r[5]}</td>
              <td>${r[6]}</td>
              <td>${r[7]}</td>
              <td>${fileLink}</td>
            </tr>`;
          });

          tbody.innerHTML = html;

          new DataTable("#tabel-detail", {
            pageLength: 10,
            language: {
              search: "Cari:",
              lengthMenu: "Tampilkan _MENU_ data",
              info: "Menampilkan _START_ - _END_ dari _TOTAL_ data",
              paginate: { next: "›", previous: "‹" },
              zeroRecords: "Tidak ada data ditemukan",
            },
          });
        } catch (err) {
          tbody.innerHTML = `<tr><td colspan='8' class='text-danger'>Gagal memuat data.</td></tr>`;
        }
      }

      renderDetail();
    </script>
  </body>
</html>
